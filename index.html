<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura Rápida</title>
    <!-- Se usan enlaces absolutos para las bibliotecas de JavaScript para garantizar que funcionen en cualquier entorno de alojamiento web, como GitHub Pages. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@400;600&family=Fira+Code:wght@400;600&display=swap');
        
        /* CSS custom properties for dynamic colors */
        :root {
            --highlight-color: #fde68a; /* Default highlight color */
            --text-color: #1f2937; /* Default text color (gray-800) */
            --bg-color: #f3f4f6;
            --border-color: #e5e7eb;
            --input-bg-color: #ffffff;
            --input-text-color: #333333;
        }
        
        /* Theme classes */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            color: var(--text-color); /* The main body text color is now separate from the reading area color */
        }
        .light {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --input-bg-color: #ffffff;
            --input-text-color: #333333;
        }
        .dark {
            --bg-color: #1f2937;
            --highlight-color: #a16207; /* Darker highlight for dark mode */
            --text-color: #e5e7eb;
            --border-color: #374151;
            --input-bg-color: #374151;
            --input-text-color: #e5e7eb;
        }
        .sepia {
            --bg-color: #fbf0d9;
            --highlight-color: #c9b48c;
            --text-color: #5b4636;
            --border-color: #e0d4bc;
            --input-bg-color: #f2eadc;
            --input-text-color: #5b4636;
        }
        
        /* Font classes */
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'Fira Code', monospace; }

        /* General UI improvements using CSS variables */
        .bg-card { background-color: var(--input-bg-color); }
        .border-theme { border-color: var(--border-color); }
        .text-theme { color: var(--text-color); }
        #text-input, select, .p-8 { background-color: var(--input-bg-color); color: var(--input-text-color); border-color: var(--border-color); }

        /* Reading area specific styles */
        #reading-area {
            position: relative;
        }
        #reading-area .word {
            transition: all 0.2s ease-in-out;
            border-radius: 0.25rem;
            padding: 0 0.1rem;
            cursor: pointer;
        }

        /* Styles for different highlight modes */
        #reading-area.highlight-background .word.highlighted {
            background-color: var(--highlight-color);
            padding: 0 0.2rem;
        }
        #reading-area.highlight-underline .word.highlighted {
            text-decoration: underline;
            text-decoration-color: var(--highlight-color);
            text-underline-offset: 4px;
        }
        #reading-area.highlight-bold-orp .word.highlighted {
            font-weight: bold;
        }
        #reading-area.highlight-bold-orp .word b {
            font-weight: 800;
            text-decoration: underline;
            text-underline-offset: 4px;
            text-decoration-color: var(--highlight-color);
        }

        /* Single word mode styles */
        #reading-area.single-word-mode {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: bold;
            font-size: 3rem;
            height: 10rem;
            white-space: nowrap;
            overflow: hidden;
        }

        .single-word-display {
            font-weight: 800;
        }
        
        .gaze-marker {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background-color: #ef4444; /* red-500 */
            z-index: 10;
            transform: translateX(-50%);
            pointer-events: none; /* Ignore mouse events */
        }
        
        /* General layout adjustments for smaller screens */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            font-size: 1rem; /* Increased base font size */
        }

        .bg-card {
            height: auto;
            max-width: 100%;
            overflow-y: auto;
        }

        #status-message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }

        .status-show {
            opacity: 1;
        }
        
        /* Responsive adjustments for controls */
        @media (max-width: 640px) {
            body {
                padding: 0.5rem;
                font-size: 0.875rem; /* Slightly smaller on very small screens */
            }
            .p-4 { padding: 0.5rem; }
            .md\:p-8 { padding: 1rem; }
            .text-xl { font-size: 1.25rem; }
            .text-3xl { font-size: 1.75rem; }
            .text-sm { font-size: 0.875rem; }
            .text-xs { font-size: 0.75rem; }
            .py-2 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
            .py-3 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
            .px-4 { padding-left: 0.5rem; padding-right: 0.5rem; }
            .px-6 { padding-left: 1rem; padding-right: 1rem; }
            .h-20 { height: 6rem; }

            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
             .gap-4 { gap: 0.5rem; }
            .md\:w-1\/3 {
                width: 100%;
            }
        }
    </style>
</head>
<body class="light flex flex-col items-center justify-center min-h-screen p-4" style="background-color: var(--bg-color);">

    <!-- Status Message Box -->
    <div id="status-message-box" class="bg-blue-500 text-white font-semibold"></div>

    <div class="bg-card rounded-2xl shadow-xl p-4 md:p-8 max-w-4xl w-full border border-theme">
        <div class="flex flex-col md:flex-row items-center justify-between mb-4">
            <h1 class="text-xl md:text-3xl font-bold mb-2 md:mb-0">Lectura Rápida</h1>
            <div class="flex items-center gap-2 md:gap-4">
                <button id="save-button" class="bg-blue-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 shadow-md text-xs md:text-sm">
                    Guardar Sesión
                </button>
                <button id="load-button" class="bg-gray-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-200 shadow-md text-xs md:text-sm">
                    Cargar Sesión
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
            <div id="progress-bar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
        </div>
        
        <!-- Main Application Container -->
        <div class="flex flex-col items-center w-full">
            
            <!-- Text Input and File Upload -->
            <div id="text-input-section" class="flex flex-col md:flex-row w-full gap-2 mb-2">
                <textarea id="text-input" class="flex-1 h-20 md:h-28 p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Pega aquí el texto o haz clic en 'Cargar Archivo' para un .txt o .pdf."></textarea>
                <div class="flex flex-col gap-2 w-full md:w-auto">
                    <label id="file-input-label-text" for="file-input-text" class="bg-indigo-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 shadow-md cursor-pointer text-center whitespace-nowrap text-xs md:text-sm">
                        Cargar Archivo
                    </label>
                    <input type="file" id="file-input-text" accept=".txt, .pdf" class="hidden">
                    <label id="file-input-label-image" for="file-input-image" class="bg-indigo-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 shadow-md cursor-pointer text-center whitespace-nowrap text-xs md:text-sm">
                        Extraer texto de Imagen
                    </label>
                    <input type="file" id="file-input-image" accept=".jpg, .jpeg, .png, .webp" class="hidden">
                </div>
            </div>

            <!-- Practice Mode Button -->
            <div class="w-full mb-2">
                 <button id="practice-button" class="bg-purple-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 shadow-md w-full text-xs md:text-sm">
                    Modo Práctica
                </button>
            </div>
            
            <!-- Critical Reading Prompts Section -->
            <div id="critical-reading-questions-container" class="w-full mb-2 p-3 rounded-xl border border-theme" style="display: none;">
                <!-- New: separate sections for multiple choice and free-form questions -->
                <div id="multiple-choice-section" class="mb-4">
                    <h3 class="font-bold text-sm md:text-lg mb-1">Preguntas de Comprensión (Opción Múltiple)</h3>
                    <div id="multiple-choice-questions" class="text-sm space-y-2">
                        <!-- Multiple choice questions will be inserted here -->
                    </div>
                    <!-- Self-evaluation section -->
                    <div id="self-evaluation-section" class="mt-4 hidden">
                         <button id="check-answers-button" class="bg-blue-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 shadow-md w-full text-xs md:text-sm">
                            Comprobar Respuestas
                        </button>
                        <div id="evaluation-results" class="mt-2 p-2 rounded-xl text-center font-semibold" style="display:none;"></div>
                    </div>
                </div>
                
                <div id="critical-reading-section">
                    <h3 class="font-bold text-sm md:text-lg mb-1">Preguntas de Lectura Crítica</h3>
                    <div id="critical-reading-questions" class="text-sm space-y-2">
                        <!-- Critical reading questions will be inserted here -->
                    </div>
                </div>
                <div id="loading-questions" class="hidden text-center text-gray-500 italic text-sm">
                    Generando preguntas...
                </div>
            </div>
            <div class="w-full mb-2">
                 <button id="generate-questions-button" class="bg-teal-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-200 shadow-md w-full text-xs md:text-sm">
                    Generar Preguntas
                </button>
            </div>
            

            <!-- Reading Display Area -->
            <div id="reading-display-container" class="relative w-full mb-2">
                <div id="reading-area" class="bg-card w-full h-24 md:h-40 p-2 md:p-4 border rounded-xl overflow-y-auto focus:outline-none border-theme">
                    <span id="reading-intro" class="text-center italic text-gray-600">El texto de tu lectura aparecerá aquí.</span>
                </div>
            </div>
            
            <!-- Word Counter and Stats -->
            <div class="w-full flex flex-col md:flex-row justify-between mb-2 text-xs md:text-sm text-gray-600">
                <div id="word-counter" class="mb-1 md:mb-0"></div>
                <div id="stats-display" class="mb-1 md:mb-0 text-right"></div>
            </div>

            <!-- Application Controls -->
            <div id="main-controls-container" class="w-full grid grid-cols-3 gap-2 mb-2">
                <button id="back-button" class="bg-gray-400 text-white font-semibold py-2 px-3 rounded-xl hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Atrás
                </button>
                <button id="start-button" class="bg-green-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.189l-3.296 2.083a1 1 0 01-1.455-.788V9.124a1 1 0 011.455-.788l3.296 2.083a1 1 0 010 1.57z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Iniciar
                </button>
                <button id="pause-button" class="bg-yellow-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m4-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausar
                </button>
                <button id="stop-button" class="bg-red-500 text-white font-semibold py-2 px-3 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Parar
                </button>
                <button id="next-button" class="bg-gray-400 text-white font-semibold py-2 px-3 rounded-xl hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    Adelante
                </button>
                 <button id="clear-button" class="bg-red-700 text-white font-semibold py-2 px-3 rounded-xl hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-700 transition duration-200 shadow-md flex items-center justify-center text-xs md:text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Borrar
                </button>
            </div>
            
            <!-- Customization Controls Row 1 -->
            <div id="custom-controls-row-1" class="w-full flex flex-col md:flex-row items-center gap-2">
                <!-- WPM Slider -->
                <div class="flex items-center gap-1 w-full md:w-1/3">
                    <label for="wpm-slider" class="text-xs font-medium whitespace-nowrap">PPM:</label>
                    <span id="wpm-value" class="w-8 text-center font-bold">300</span>
                    <input type="range" id="wpm-slider" min="100" max="1000" value="300" step="10" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- Theme Select -->
                <div class="flex items-center gap-1 w-full md:w-1/3">
                    <label for="theme-select" class="text-xs font-medium whitespace-nowrap">Tema:</label>
                    <select id="theme-select" class="w-full p-1 rounded-lg border text-xs">
                        <option value="light">Claro</option>
                        <option value="dark">Oscuro</option>
                        <option value="sepia">Sepia</option>
                    </select>
                </div>
                
                <!-- Font Select -->
                <div class="flex items-center gap-1 w-full md:w-1/3">
                    <label for="font-select" class="text-xs font-medium whitespace-nowrap">Fuente:</label>
                    <select id="font-select" class="w-full p-1 rounded-lg border text-xs">
                        <option value="inter">Inter</option>
                        <option value="serif">Serif</option>
                        <option value="mono">Mono</option>
                    </select>
                </div>
            </div>
            
            <!-- Customization Controls Row 2 -->
            <div id="custom-controls-row-2" class="w-full flex flex-col md:flex-row items-center gap-2 mt-2">
                <!-- Font Size Slider -->
                <div class="flex items-center gap-1 w-full md:w-1/2">
                    <label for="font-size-slider" class="text-xs font-medium whitespace-nowrap">Tamaño:</label>
                    <span id="font-size-value" class="w-8 text-center font-bold">14</span>
                    <input type="range" id="font-size-slider" min="12" max="32" value="14" step="1" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- Mode Select -->
                <div class="flex items-center gap-1 w-full md:w-1/2">
                    <label for="mode-select" class="text-xs font-medium whitespace-nowrap">Modo:</label>
                    <select id="mode-select" class="w-full p-1 rounded-lg border text-xs">
                        <option value="highlight">Resaltado</option>
                        <option value="single-word">Una palabra a la vez</option>
                    </select>
                </div>
            </div>

            <!-- Customization Controls Row 3 -->
            <div id="highlight-controls" class="w-full flex flex-col md:flex-row items-center gap-2 mt-2">
                <!-- Highlight Style Select -->
                <div class="flex items-center gap-1 w-full md:w-1/2">
                    <label for="highlight-style-select" class="text-xs font-medium whitespace-nowrap">Estilo:</label>
                    <select id="highlight-style-select" class="w-full p-1 rounded-lg border text-xs">
                        <option value="highlight-background">Fondo</option>
                        <option value="highlight-underline">Subrayado</option>
                        <option value="highlight-bold-orp">Negrita (ORP)</option>
                    </select>
                </div>
                
                <!-- Words per Chunk Slider -->
                <div class="flex items-center gap-1 w-full md:w-1/2">
                    <label for="words-per-chunk-slider" class="text-xs font-medium whitespace-nowrap">Grupo:</label>
                    <span id="words-per-chunk-value" class="w-8 text-center font-bold">1</span>
                    <input type="range" id="words-per-chunk-slider" min="1" max="10" value="1" step="1" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            
        </div>
    </div>
    <script>
        // API Configuration and Variables
        const API_KEY = "AIzaSyDg7-ZvjoBvaegUcHgi_McIn8l68hYBs6k"; // Leave as empty string for local execution in Canvas.
        const GENERATION_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        
        let isReading = false;
        let readingTimeout;
        let currentIndex = 0;
        let words = [];
        let totalWords = 0;
        let multipleChoiceQuestions = [];

        // DOM Elements
        const textInput = document.getElementById('text-input');
        const startButton = document.getElementById('start-button');
        const pauseButton = document.getElementById('pause-button');
        const stopButton = document.getElementById('stop-button');
        const backButton = document.getElementById('back-button');
        const nextButton = document.getElementById('next-button');
        const clearButton = document.getElementById('clear-button');
        const wpmSlider = document.getElementById('wpm-slider');
        const wpmValue = document.getElementById('wpm-value');
        const themeSelect = document.getElementById('theme-select');
        const fontSelect = document.getElementById('font-select');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const modeSelect = document.getElementById('mode-select');
        const highlightControls = document.getElementById('highlight-controls');
        const highlightStyleSelect = document.getElementById('highlight-style-select');
        const wordsPerChunkSlider = document.getElementById('words-per-chunk-slider');
        const wordsPerChunkValue = document.getElementById('words-per-chunk-value');
        const readingArea = document.getElementById('reading-area');
        const readingIntro = document.getElementById('reading-intro');
        const wordCounter = document.getElementById('word-counter');
        const statsDisplay = document.getElementById('stats-display');
        const progressBar = document.getElementById('progress-bar');
        const fileInputText = document.getElementById('file-input-text');
        const fileInputImage = document.getElementById('file-input-image');
        const practiceButton = document.getElementById('practice-button');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const criticalReadingQuestionsContainer = document.getElementById('critical-reading-questions-container');
        const multipleChoiceQuestionsDiv = document.getElementById('multiple-choice-questions');
        const criticalReadingQuestionsDiv = document.getElementById('critical-reading-questions');
        const loadingQuestionsDiv = document.getElementById('loading-questions');
        const checkAnswersButton = document.getElementById('check-answers-button');
        const selfEvaluationSection = document.getElementById('self-evaluation-section');
        const evaluationResultsDiv = document.getElementById('evaluation-results');

        // Helper functions
        function showStatusMessage(message) {
            const statusBox = document.getElementById('status-message-box');
            statusBox.textContent = message;
            statusBox.classList.add('status-show');
            setTimeout(() => {
                statusBox.classList.remove('status-show');
            }, 3000);
        }

        // --- Core Reading Logic ---
        function updateReadingDisplay(text) {
            if (!text) {
                readingArea.innerHTML = `<span id="reading-intro" class="text-center italic text-gray-600">El texto de tu lectura aparecerá aquí.</span>`;
                words = [];
                totalWords = 0;
                wordCounter.textContent = '';
                statsDisplay.textContent = '';
                return;
            }

            // CORREGIDO: Expresión regular para incluir caracteres acentuados y la 'ñ'
            words = text.match(/\b[\wáéíóúüñÁÉÍÓÚÜÑ'-]+\b/g) || [];
            totalWords = words.length;
            wordCounter.textContent = `Palabra: ${currentIndex + 1} de ${totalWords}`;
            updateStats();

            // Set the appropriate reading mode class on the reading area
            readingArea.className = `bg-card w-full h-24 md:h-40 p-2 md:p-4 border rounded-xl overflow-y-auto focus:outline-none border-theme ${modeSelect.value}-mode ${highlightStyleSelect.value}`;

            if (modeSelect.value === 'highlight') {
                readingArea.innerHTML = words.map((word, index) => {
                    const normalizedWord = word.replace(/[^a-zA-ZáéíóúüñÁÉÍÓÚÜÑ'-]/g, '');
                    return `<span class="word" data-index="${index}">${word}</span>`;
                }).join(' ');
                displayCurrentWord(currentIndex);
            } else if (modeSelect.value === 'single-word') {
                displayCurrentWord(currentIndex);
            }
        }

        function displayCurrentWord(index) {
            if (index < 0 || index >= words.length) {
                stopReading();
                return;
            }

            currentIndex = index;
            const wordsPerChunk = parseInt(wordsPerChunkSlider.value, 10);
            const start = currentIndex;
            const end = Math.min(currentIndex + wordsPerChunk, totalWords);

            // Update progress bar
            const progress = (currentIndex / totalWords) * 100;
            progressBar.style.width = `${progress}%`;

            if (modeSelect.value === 'single-word') {
                const chunk = words.slice(start, end).join(' ');
                readingArea.innerHTML = `<span class="single-word-display">${chunk}</span>`;
            } else { // highlight mode
                const allWordSpans = readingArea.querySelectorAll('.word');
                allWordSpans.forEach(span => span.classList.remove('highlighted'));

                for (let i = start; i < end; i++) {
                    const wordSpan = readingArea.querySelector(`[data-index="${i}"]`);
                    if (wordSpan) {
                        wordSpan.classList.add('highlighted');
                        // Scroll into view
                        const container = readingArea;
                        const element = wordSpan;
                        const containerRect = container.getBoundingClientRect();
                        const elementRect = element.getBoundingClientRect();

                        if (elementRect.bottom > containerRect.bottom || elementRect.top < containerRect.top) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }

            wordCounter.textContent = `Palabra: ${currentIndex + 1} de ${totalWords}`;
            updateStats();
        }

        function updateStats() {
            const wpm = parseInt(wpmSlider.value, 10);
            const wordsRemaining = totalWords - currentIndex - 1;
            const minutesRemaining = Math.ceil(wordsRemaining / wpm);
            statsDisplay.textContent = `PPM: ${wpm} | Tiempo restante: ~${minutesRemaining} min`;
        }

        function startReading() {
            if (isReading) return;
            isReading = true;
            startButton.textContent = 'Reanudar';
            startButton.classList.remove('bg-green-500');
            startButton.classList.add('bg-blue-500');
            readingLoop();
        }

        function pauseReading() {
            isReading = false;
            clearTimeout(readingTimeout);
            startButton.textContent = 'Reanudar';
            startButton.classList.remove('bg-green-500');
            startButton.classList.add('bg-blue-500');
        }

        function stopReading() {
            pauseReading();
            currentIndex = 0;
            updateReadingDisplay(textInput.value);
            startButton.textContent = 'Iniciar';
            startButton.classList.remove('bg-blue-500');
            startButton.classList.add('bg-green-500');
            progressBar.style.width = `0%`;
        }

        function nextWord() {
            pauseReading();
            currentIndex++;
            displayCurrentWord(currentIndex);
        }

        function prevWord() {
            pauseReading();
            currentIndex = Math.max(0, currentIndex - 1);
            displayCurrentWord(currentIndex);
        }

        function readingLoop() {
            if (!isReading || currentIndex >= totalWords) {
                stopReading();
                return;
            }
            displayCurrentWord(currentIndex);
            currentIndex += parseInt(wordsPerChunkSlider.value, 10);
            const wpm = parseInt(wpmSlider.value, 10);
            const delay = (60000 / wpm) * parseInt(wordsPerChunkSlider.value, 10);
            readingTimeout = setTimeout(readingLoop, delay);
        }

        // --- Question Generation Logic ---
        async function generateQuestions() {
            const text = textInput.value;
            if (text.length === 0) {
                showStatusMessage('Por favor, ingresa un texto para generar preguntas.');
                return;
            }
            
            // Show loading indicator
            loadingQuestionsDiv.classList.remove('hidden');
            criticalReadingQuestionsContainer.style.display = 'block';
            generateQuestionsButton.disabled = true;

            const prompt = `Con base en el siguiente texto, crea 3 preguntas de comprensión de opción múltiple, cada una con 4 opciones y una respuesta correcta. Además, crea 3 preguntas de lectura crítica de formato libre. La salida debe ser un objeto JSON con dos arrays: 'multiple_choice' y 'critical_reading'. Los objetos de 'multiple_choice' deben tener 'question', 'options' (un array), y 'correct_answer' (un string). Los objetos de 'critical_reading' deben tener un 'question' (un string). La respuesta completa debe ser un único objeto JSON. No incluyas ningún otro texto, explicaciones o código fuera del JSON.
            
            Texto a analizar:
            "${text}"
            `;
            
            // NOTE: The API_KEY below is for demonstration within the Canvas environment.
            // When deploying to a public site like GitHub Pages, you must use a valid API key.
            // You can get one from Google AI Studio: https://aistudio.google.com/
            const isLocalExecution = GENERATION_API_URL.endsWith("key=");
            if (isLocalExecution) {
                console.log("Using a placeholder API key for local execution. Get a valid key for external deployment.");
            }

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "multiple_choice": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "question": { "type": "STRING" },
                                            "options": {
                                                "type": "ARRAY",
                                                "items": { "type": "STRING" }
                                            },
                                            "correct_answer": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["question", "options", "correct_answer"]
                                    }
                                },
                                "critical_reading": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "question": { "type": "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                const response = await fetch(GENERATION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result || !result.candidates || result.candidates.length === 0 || !result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                    throw new Error("Invalid response structure from API.");
                }

                const jsonString = result.candidates[0].content.parts[0].text;
                const questionsData = JSON.parse(jsonString);
                
                multipleChoiceQuestions = questionsData.multiple_choice;
                const criticalReadingQuestions = questionsData.critical_reading;
                
                displayMultipleChoiceQuestions(multipleChoiceQuestions);
                displayCriticalReadingQuestions(criticalReadingQuestions);

            } catch (error) {
                console.error('Error generating questions:', error);
                showStatusMessage('Hubo un error al generar las preguntas. Por favor, inténtalo de nuevo.');
                // Re-enable button on error
                generateQuestionsButton.disabled = false;
            } finally {
                loadingQuestionsDiv.classList.add('hidden');
                generateQuestionsButton.disabled = false;
            }
        }

        function displayMultipleChoiceQuestions(questions) {
            multipleChoiceQuestionsDiv.innerHTML = '';
            questions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-100 p-3 rounded-lg shadow-sm mb-3';
                questionDiv.innerHTML = `<p class="font-semibold mb-2">${qIndex + 1}. ${q.question}</p>`;
                
                q.options.forEach((option, oIndex) => {
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'block mb-1';
                    optionLabel.innerHTML = `
                        <input type="radio" name="question-${qIndex}" value="${option}" class="mr-2">
                        ${option}
                    `;
                    questionDiv.appendChild(optionLabel);
                });
                multipleChoiceQuestionsDiv.appendChild(questionDiv);
            });
            if (questions.length > 0) {
                 selfEvaluationSection.classList.remove('hidden');
            }
        }
        
        function displayCriticalReadingQuestions(questions) {
            criticalReadingQuestionsDiv.innerHTML = '';
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-100 p-3 rounded-lg shadow-sm mb-3';
                questionDiv.innerHTML = `<p class="font-semibold mb-2">${index + 1}. ${q.question}</p>`;
                criticalReadingQuestionsDiv.appendChild(questionDiv);
            });
        }
        
        function checkAnswers() {
            let correctAnswers = 0;
            const totalQuestions = multipleChoiceQuestions.length;
            
            evaluationResultsDiv.innerHTML = '';
            evaluationResultsDiv.style.display = 'block';

            multipleChoiceQuestions.forEach((q, qIndex) => {
                const selectedOption = document.querySelector(`input[name="question-${qIndex}"]:checked`);
                const questionDiv = document.querySelector(`#multiple-choice-questions > div:nth-child(${qIndex + 1})`);
                
                // Remove previous feedback classes
                questionDiv.classList.remove('border-green-500', 'border-red-500', 'border-2');
                
                const allOptions = questionDiv.querySelectorAll('label');
                allOptions.forEach(label => {
                    label.classList.remove('text-green-600', 'text-red-600', 'font-bold');
                });

                if (selectedOption) {
                    const selectedValue = selectedOption.value;
                    
                    if (selectedValue === q.correct_answer) {
                        correctAnswers++;
                        questionDiv.classList.add('border-green-500', 'border-2');
                        selectedOption.closest('label').classList.add('text-green-600', 'font-bold');
                    } else {
                        questionDiv.classList.add('border-red-500', 'border-2');
                        selectedOption.closest('label').classList.add('text-red-600', 'font-bold');
                        // Highlight the correct answer
                        const correctLabel = Array.from(allOptions).find(label => label.textContent.trim() === q.correct_answer);
                        if (correctLabel) {
                            correctLabel.classList.add('text-green-600', 'font-bold');
                        }
                    }
                } else {
                    // No answer selected, just highlight the correct one
                    questionDiv.classList.add('border-red-500', 'border-2');
                    const correctLabel = Array.from(allOptions).find(label => label.textContent.trim() === q.correct_answer);
                    if (correctLabel) {
                        correctLabel.classList.add('text-green-600', 'font-bold');
                    }
                }
            });

            const percentage = (correctAnswers / totalQuestions) * 100;
            let message = `Obtuviste ${correctAnswers} de ${totalQuestions} correctas (${percentage.toFixed(0)}%).`;
            if (percentage >= 80) {
                evaluationResultsDiv.classList.remove('bg-red-200');
                evaluationResultsDiv.classList.add('bg-green-200');
                message += ' ¡Excelente trabajo!';
            } else if (percentage >= 50) {
                evaluationResultsDiv.classList.remove('bg-red-200');
                evaluationResultsDiv.classList.add('bg-yellow-200');
                message += ' ¡Bien hecho! Sigue practicando.';
            } else {
                evaluationResultsDiv.classList.remove('bg-yellow-200');
                evaluationResultsDiv.classList.add('bg-red-200');
                message += ' Sigue intentándolo.';
            }

            evaluationResultsDiv.textContent = message;
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            if (words.length > 0) {
                startReading();
            } else {
                showStatusMessage('Por favor, ingresa un texto para comenzar.');
            }
        });
        pauseButton.addEventListener('click', pauseReading);
        stopButton.addEventListener('click', stopReading);
        backButton.addEventListener('click', prevWord);
        nextButton.addEventListener('click', nextWord);
        clearButton.addEventListener('click', () => {
            stopReading();
            textInput.value = '';
            updateReadingDisplay('');
            
            // Clear all questions and hide their containers
            multipleChoiceQuestions = [];
            multipleChoiceQuestionsDiv.innerHTML = '';
            criticalReadingQuestionsDiv.innerHTML = '';
            criticalReadingQuestionsContainer.style.display = 'none';
            selfEvaluationSection.classList.add('hidden');
            evaluationResultsDiv.style.display = 'none';
        });
        wpmSlider.addEventListener('input', () => {
            wpmValue.textContent = wpmSlider.value;
            updateStats();
        });
        themeSelect.addEventListener('change', (e) => {
            document.body.className = `${e.target.value} flex flex-col items-center justify-center min-h-screen p-4`;
        });
        fontSelect.addEventListener('change', (e) => {
            readingArea.className = `bg-card w-full h-24 md:h-40 p-2 md:p-4 border rounded-xl overflow-y-auto focus:outline-none border-theme ${modeSelect.value}-mode ${highlightStyleSelect.value} font-${e.target.value}`;
        });
        fontSizeSlider.addEventListener('input', (e) => {
            fontSizeValue.textContent = e.target.value;
            readingArea.style.fontSize = `${e.target.value}px`;
        });
        modeSelect.addEventListener('change', (e) => {
            const isHighlightMode = e.target.value === 'highlight';
            highlightControls.style.display = isHighlightMode ? 'flex' : 'none';
            
            // Fix: set words per chunk to 1 and disable when in single-word mode
            if (!isHighlightMode) {
                wordsPerChunkSlider.value = '1';
                wordsPerChunkValue.textContent = '1';
                wordsPerChunkSlider.disabled = true;
            } else {
                wordsPerChunkSlider.disabled = false;
            }

            readingArea.classList.toggle('single-word-mode', !isHighlightMode);
            updateReadingDisplay(textInput.value);
            stopReading();
        });
        highlightStyleSelect.addEventListener('change', (e) => {
            readingArea.classList.remove('highlight-background', 'highlight-underline', 'highlight-bold-orp');
            readingArea.classList.add(e.target.value);
            displayCurrentWord(currentIndex);
        });
        wordsPerChunkSlider.addEventListener('input', () => {
            wordsPerChunkValue.textContent = wordsPerChunkSlider.value;
        });

        textInput.addEventListener('input', (e) => {
            updateReadingDisplay(e.target.value);
            stopReading();
        });

        fileInputText.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    let content = '';
                    if (fileExtension === 'pdf') {
                        const loadingTask = pdfjsLib.getDocument(event.target.result);
                        const pdf = await loadingTask.promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            content += textContent.items.map(item => item.str).join(' ');
                        }
                    } else { // .txt
                        content = event.target.result;
                    }
                    textInput.value = content;
                    updateReadingDisplay(content);
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        fileInputImage.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Tesseract.recognize(
                    file,
                    'spa',
                    { logger: m => console.log(m) }
                ).then(({ data: { text } }) => {
                    textInput.value = text;
                    updateReadingDisplay(text);
                });
            }
        });

        // Event listener for the new "Practice Mode" button
        practiceButton.addEventListener('click', () => {
            const practiceText = `El espacio es vasto y, en su mayoría, vacío. Las distancias entre las estrellas y las galaxias son tan grandes que la luz, que viaja a una velocidad asombrosa de 299.792 kilómetros por segundo, tarda años, décadas, o incluso millones de años en recorrerlas. Por ejemplo, la estrella más cercana a nuestro sol, Proxima Centauri, está a unos 4.2 años luz de distancia. Esto significa que la luz que vemos de ella hoy salió hace más de cuatro años. Esta inmensidad es lo que hace que la exploración espacial tripulada sea un desafío tan monumental, obligándonos a pensar en tecnologías y enfoques que van más allá de nuestra experiencia actual en la Tierra.`;
            textInput.value = practiceText;
            updateReadingDisplay(practiceText);
            stopReading();
            showStatusMessage('Texto de práctica cargado. ¡Ahora puedes empezar a leer!');
        });

        generateQuestionsButton.addEventListener('click', generateQuestions);
        checkAnswersButton.addEventListener('click', checkAnswers);

        readingArea.addEventListener('click', (event) => {
            const target = event.target;
            // Check if the clicked element is a word span
            if (target.classList.contains('word') && modeSelect.value === 'highlight') {
                const newIndex = parseInt(target.dataset.index, 10);
                if (!isNaN(newIndex)) {
                    currentIndex = newIndex;
                    pauseReading();
                    displayCurrentWord(currentIndex);
                    showStatusMessage(`Posición de inicio cambiada a la palabra ${newIndex + 1}.`);
                }
            }
        });

        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                event.preventDefault();
                isReading ? pauseReading() : startReading();
            }
            if (event.code === 'ArrowLeft') {
                event.preventDefault();
                prevWord();
            }
            if (event.code === 'ArrowRight') {
                event.preventDefault();
                nextWord();
            }
        });
        
        // Initial setup to show/hide controls based on default mode
        const isHighlightModeInitially = modeSelect.value === 'highlight';
        highlightControls.style.display = isHighlightModeInitially ? 'flex' : 'none';

        // Initial setup to update reading display if text is already present
        if (textInput.value.trim().length > 0) {
            updateReadingDisplay(textInput.value);
        }
    </script>
</body>
</html>

